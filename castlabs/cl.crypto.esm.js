import {clpp} from "./cl.core.esm.js";let g={};var _ = clpp._;var f=function(window){var QB=function(a){var b=void 0===b?Infinity:b;return _.df(a,b,Int32Array)},RB=function(){this.l=[0,1,2,4,8,16,32,64,128,27,54];this.m=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)];this.g=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)];this.j=new Uint32Array(256);this.h=new Uint32Array(256);this.i=new Uint32Array(0);this.c=this.a=this.f=this.b=null;var a=this.j,b=this.h,c=this.m,d=c[0],e=c[1],f=c[2];c=c[3];var g=this.g,
h=g[0],l=g[1],m=g[2];g=g[3];var n=new Uint32Array(256),p=0,q=0,t;for(t=0;256>t;t++)n[t]=128>t?t<<1:t<<1^283;for(t=0;256>t;t++){var v=q^q<<1^q<<2^q<<3^q<<4;v=v>>>8^v&255^99;a[p]=v;b[v]=p;var z=n[p],F=n[z],E=n[F],D=257*n[v]^16843008*v;d[p]=D<<24|D>>>8;e[p]=D<<16|D>>>16;f[p]=D<<8|D>>>24;c[p]=D;D=16843009*E^65537*F^257*z^16843008*p;h[v]=D<<24|D>>>8;l[v]=D<<16|D>>>16;m[v]=D<<8|D>>>24;g[v]=D;p?(p=z^n[n[n[E^z]]],q^=n[n[q]]):p=q=1}},SB=function(a){a=new DataView(a);for(var b=new Uint32Array(4),c=0;4>c;c++)b[c]=
a.getUint32(4*c);return b},TB=function(){this.a=null},UB=function(){this.b=this.c=null;this.h=this.uj.bind(this);this.g={};this.a=null;this.f=new _.H("clpp.crypto")},VB=function(a,b){var c,d;return _.A(function(e){if(1==e.a){if(a.g[b])return e["return"](a.g[b]);c=_.Gi(b);return _.x(e,a.b.fetch(c).promise,2)}d=e.b;a.g[b]=d.data;return e["return"](d.data)})},WB=function(a,b,c){var d,e,f,g;return _.A(function(h){switch(h.a){case 1:return d=new ArrayBuffer(0),_.Ce(h,2),_.x(h,VB(a,c.url),4);case 4:d=h.b;
_.De(h,3);break;case 2:return e=_.Ee(h),a.f.debug("Could not fetch key"),a.c.onError(new _.J(1,7,7104,null,e)),h["return"](b);case 3:return _.Ce(h,5),_.x(h,a.a.importKey(d),7);case 7:return _.x(h,a.a.decrypt(b,c.iv.buffer),8);case 8:return f=h.b,h["return"](f);case 5:return g=_.Ee(h),a.f.warn("Could not decrypt segment data!",g),a.c.onError(new _.J(1,3,3103,null,g)),h["return"](b)}})};
RB.prototype.importKey=function(a){a=SB(a);for(var b=!0,c=0;c<a.length&&b;)b=a[c]===this.i[c],c++;if(b)return new Promise(function(m){return m()});this.i=a;this.a=a.length;if(4!==this.a&&6!==this.a&&8!==this.a)throw Error("Invalid aes key size\x3d"+this.a);this.c=4*(this.a+7);this.b=new Uint32Array(this.c);this.f=new Uint32Array(this.c);b=this.j;var d=this.l;var e=this.g;c=e[0];var f=e[1],g=e[2],h=e[3];for(e=0;e<this.c;e++)if(e<this.a)var l=this.b[e]=a[e];else 0===e%this.a?(l=l<<8|l>>>24,l=b[l>>>
24]<<24|b[l>>>16&255]<<16|b[l>>>8&255]<<8|b[l&255],l^=d[e/this.a|0]<<24):6<this.a&&4===e%this.a&&(l=b[l>>>24]<<24|b[l>>>16&255]<<16|b[l>>>8&255]<<8|b[l&255]),l=(this.b[e-this.a]^l)>>>0,this.b[e]=l;for(a=0;a<this.c;a++)e=this.c-a,l=a&3?this.b[e]:this.b[e-4],this.f[a]=4>a||4>=e?l:c[b[l>>>24]]^f[b[l>>>16&255]]^g[b[l>>>8&255]]^h[b[l&255]],this.f[a]>>>=0;return new Promise(function(m){return m()})};
RB.prototype.decrypt=function(a,b){var c=0,d=this.a+6,e=this.f,f=this.h,g=this.g,h=g[0],l=g[1],m=g[2];g=g[3];var n=SB(b),p=n[0],q=n[1],t=n[2];n=n[3];for(var v=QB(a),z=new Int32Array(v.length),F,E,D,L,R,oa,Da,Ua,Ka,Ob,xb,La,Va,rb=this.o.bind(this);c<v.length;){Ua=rb(v[c]);Ka=rb(v[c+1]);Ob=rb(v[c+2]);xb=rb(v[c+3]);R=Ua^e[0];oa=xb^e[1];Da=Ob^e[2];L=Ka^e[3];La=4;for(Va=1;Va<d;Va++)F=h[R>>>24]^l[oa>>16&255]^m[Da>>8&255]^g[L&255]^e[La],E=h[oa>>>24]^l[Da>>16&255]^m[L>>8&255]^g[R&255]^e[La+1],D=h[Da>>>24]^
l[L>>16&255]^m[R>>8&255]^g[oa&255]^e[La+2],L=h[L>>>24]^l[R>>16&255]^m[oa>>8&255]^g[Da&255]^e[La+3],R=F,oa=E,Da=D,La+=4;F=f[R>>>24]<<24^f[oa>>16&255]<<16^f[Da>>8&255]<<8^f[L&255]^e[La];E=f[oa>>>24]<<24^f[Da>>16&255]<<16^f[L>>8&255]<<8^f[R&255]^e[La+1];D=f[Da>>>24]<<24^f[L>>16&255]<<16^f[R>>8&255]<<8^f[oa&255]^e[La+2];L=f[L>>>24]<<24^f[R>>16&255]<<16^f[oa>>8&255]<<8^f[Da&255]^e[La+3];La+=3;z[c]=rb(F^p);z[c+1]=rb(L^q);z[c+2]=rb(D^t);z[c+3]=rb(E^n);p=Ua;q=Ka;t=Ob;n=xb;c+=4}return new Promise(function(Qb){var hb=
z.buffer;var kb=hb.byteLength,Gb=kb&&(new DataView(hb)).getUint8(kb-1);hb=Gb?hb.slice(0,kb-Gb):hb;Qb(hb)})};RB.prototype.destroy=function(){this.l=this.f=this.b=this.g=this.m=this.h=this.j=this.c=this.a=this.i=null;return new Promise(function(a){return a()})};RB.prototype.o=function(a){return a<<24|(a&65280)<<8|(a&16711680)>>8|a>>>24};TB.prototype.importKey=function(a){var b=this,c;return _.A(function(d){if(1==d.a)return c=b,_.x(d,crypto.subtle.importKey("raw",a,{name:"AES-CBC"},!1,["decrypt"]),2);c.a=d.b;_.y(d)})};TB.prototype.decrypt=function(a,b){var c=this,d;return _.A(function(e){if(1==e.a)return _.x(e,crypto.subtle.decrypt({name:"AES-CBC",iv:b},c.a,a),2);d=e.b;return e["return"](d)})};TB.prototype.destroy=function(){this.a=null;return new Promise(function(a){return a()})};_.w(UB,_.nl);_.r=UB.prototype;_.r.rb=function(a){this.c=a};_.r.ib=function(){this.c=null};_.r.wc=function(){if(window.crypto&&window.crypto.subtle){var a=window.crypto.subtle.decrypt;a=typeof window.crypto.subtle.importKey===_.Dc&&typeof a===_.Dc}else a=!1;a?this.a=new TB:(this.f.warn("No WebCrypto APIs found. Will fallback to software AES"),this.a=new RB);this.b=this.c.getNetworkEngine();this.b.zd(this.h)};
_.r.release=function(){this.b&&this.b.oe(this.h);this.a&&(this.a.destroy(),this.a=null);this.b=null;this.g={}};_.r.id=function(){return"clpp.component.crypto"};_.r.uj=function(a){var b=this,c,d;return _.A(function(e){if(1==e.a){c=a.request||null;if(!c||c.type!==_.to||!c.keyInfo||!a.data)return e.C(2);b.f.debug("Decrypt data");d=a;return _.x(e,WB(b,a.data,c.keyInfo),4)}2!=e.a&&(d.data=e.b);return e["return"](a)})};_.B("clpp.crypto.CryptoComponent",UB);};f.call(g, window);