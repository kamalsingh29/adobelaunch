import {clpp} from "./cl.core.esm.js";let g={};var _ = clpp._;var f=function(window){var DA=function(a){var b=void 0===b?Infinity:b;return _.kf(a,b,Int32Array)},EA=function(){this.l=[0,1,2,4,8,16,32,64,128,27,54];this.m=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)];this.g=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)];this.j=new Uint32Array(256);this.h=new Uint32Array(256);this.i=new Uint32Array(0);this.c=this.a=this.f=this.b=null;var a=this.j,b=this.h,c=this.m,d=c[0],e=c[1],f=c[2];c=c[3];var g=this.g,
h=g[0],l=g[1],m=g[2];g=g[3];var n=new Uint32Array(256),p=0,q=0,t;for(t=0;256>t;t++)n[t]=128>t?t<<1:t<<1^283;for(t=0;256>t;t++){var u=q^q<<1^q<<2^q<<3^q<<4;u=u>>>8^u&255^99;a[p]=u;b[u]=p;var A=n[p],D=n[A],G=n[D],H=257*n[u]^16843008*u;d[p]=H<<24|H>>>8;e[p]=H<<16|H>>>16;f[p]=H<<8|H>>>24;c[p]=H;H=16843009*G^65537*D^257*A^16843008*p;h[u]=H<<24|H>>>8;l[u]=H<<16|H>>>16;m[u]=H<<8|H>>>24;g[u]=H;p?(p=A^n[n[n[G^A]]],q^=n[n[q]]):p=q=1}},FA=function(a){a=new DataView(a);for(var b=new Uint32Array(4),c=0;4>c;c++)b[c]=
a.getUint32(4*c);return b},GA=function(){this.a=null},HA=function(){this.b=this.c=null;this.h=this.Oi.bind(this);this.g={};this.a=null;this.f=new _.E("clpp.crypto")},IA=function(a,b){var c,d;return _.z(function(e){if(1==e.a){if(a.g[b])return e["return"](a.g[b]);c=_.hg(b);return _.x(e,a.b.fetch(c).promise,2)}d=e.b;a.g[b]=d.data;return e["return"](d.data)})},JA=function(a,b,c){var d,e,f,g;return _.z(function(h){switch(h.a){case 1:return d=new ArrayBuffer(0),h.c=2,_.x(h,IA(a,c.url),4);case 4:d=h.b;_.Be(h,
3);break;case 2:return e=_.Ce(h),a.f.debug("Could not fetch key"),a.c.onError(new _.K(1,7,7104,null,e)),h["return"](b);case 3:return h.c=5,_.x(h,a.a.importKey(d),7);case 7:return _.x(h,a.a.decrypt(b,c.iv.buffer),8);case 8:return f=h.b,h["return"](f);case 5:return g=_.Ce(h),a.f.warn("Could not decrypt segment data!",g),a.c.onError(new _.K(1,3,3103,null,g)),h["return"](b)}})};
EA.prototype.importKey=function(a){a=FA(a);for(var b=!0,c=0;c<a.length&&b;)b=a[c]===this.i[c],c++;if(b)return new Promise(function(m){return m()});this.i=a;this.a=a.length;if(4!==this.a&&6!==this.a&&8!==this.a)throw Error("Invalid aes key size\x3d"+this.a);this.c=4*(this.a+7);this.b=new Uint32Array(this.c);this.f=new Uint32Array(this.c);b=this.j;var d=this.l;var e=this.g;c=e[0];var f=e[1],g=e[2],h=e[3];for(e=0;e<this.c;e++)if(e<this.a)var l=this.b[e]=a[e];else 0===e%this.a?(l=l<<8|l>>>24,l=b[l>>>
24]<<24|b[l>>>16&255]<<16|b[l>>>8&255]<<8|b[l&255],l^=d[e/this.a|0]<<24):6<this.a&&4===e%this.a&&(l=b[l>>>24]<<24|b[l>>>16&255]<<16|b[l>>>8&255]<<8|b[l&255]),l=(this.b[e-this.a]^l)>>>0,this.b[e]=l;for(a=0;a<this.c;a++)e=this.c-a,l=a&3?this.b[e]:this.b[e-4],this.f[a]=4>a||4>=e?l:c[b[l>>>24]]^f[b[l>>>16&255]]^g[b[l>>>8&255]]^h[b[l&255]],this.f[a]>>>=0;return new Promise(function(m){return m()})};
EA.prototype.decrypt=function(a,b){var c=0,d=this.a+6,e=this.f,f=this.h,g=this.g,h=g[0],l=g[1],m=g[2];g=g[3];var n=FA(b),p=n[0],q=n[1],t=n[2];n=n[3];for(var u=DA(a),A=new Int32Array(u.length),D,G,H,L,T,wa,Ra,Zc,$c,ad,kb,Ja,Lb,Ma=this.o.bind(this);c<u.length;){Zc=Ma(u[c]);$c=Ma(u[c+1]);ad=Ma(u[c+2]);kb=Ma(u[c+3]);T=Zc^e[0];wa=kb^e[1];Ra=ad^e[2];L=$c^e[3];Ja=4;for(Lb=1;Lb<d;Lb++)D=h[T>>>24]^l[wa>>16&255]^m[Ra>>8&255]^g[L&255]^e[Ja],G=h[wa>>>24]^l[Ra>>16&255]^m[L>>8&255]^g[T&255]^e[Ja+1],H=h[Ra>>>24]^
l[L>>16&255]^m[T>>8&255]^g[wa&255]^e[Ja+2],L=h[L>>>24]^l[T>>16&255]^m[wa>>8&255]^g[Ra&255]^e[Ja+3],T=D,wa=G,Ra=H,Ja+=4;D=f[T>>>24]<<24^f[wa>>16&255]<<16^f[Ra>>8&255]<<8^f[L&255]^e[Ja];G=f[wa>>>24]<<24^f[Ra>>16&255]<<16^f[L>>8&255]<<8^f[T&255]^e[Ja+1];H=f[Ra>>>24]<<24^f[L>>16&255]<<16^f[T>>8&255]<<8^f[wa&255]^e[Ja+2];L=f[L>>>24]<<24^f[T>>16&255]<<16^f[wa>>8&255]<<8^f[Ra&255]^e[Ja+3];Ja+=3;A[c]=Ma(D^p);A[c+1]=Ma(L^q);A[c+2]=Ma(H^t);A[c+3]=Ma(G^n);p=Zc;q=$c;t=ad;n=kb;c+=4}return new Promise(function(dc){var Ca=
A.buffer;var lb=Ca.byteLength,Mb=lb&&(new DataView(Ca)).getUint8(lb-1);Ca=Mb?Ca.slice(0,lb-Mb):Ca;dc(Ca)})};EA.prototype.destroy=function(){this.l=this.f=this.b=this.g=this.m=this.h=this.j=this.c=this.a=this.i=null;return new Promise(function(a){return a()})};EA.prototype.o=function(a){return a<<24|(a&65280)<<8|(a&16711680)>>8|a>>>24};GA.prototype.importKey=function(a){var b=this,c;return _.z(function(d){if(1==d.a)return c=b,_.x(d,crypto.subtle.importKey("raw",a,{name:"AES-CBC"},!1,["decrypt"]),2);c.a=d.b;_.y(d)})};GA.prototype.decrypt=function(a,b){var c=this,d;return _.z(function(e){if(1==e.a)return _.x(e,crypto.subtle.decrypt({name:"AES-CBC",iv:b},c.a,a),2);d=e.b;return e["return"](d)})};GA.prototype.destroy=function(){this.a=null;return new Promise(function(a){return a()})};_.w(HA,_.wl);_.r=HA.prototype;_.r.ub=function(a){this.c=a};_.r.cb=function(){this.c=null};_.r.lc=function(){if(window.crypto&&window.crypto.subtle){var a=window.crypto.subtle.decrypt;a=typeof window.crypto.subtle.importKey===_.Cc&&typeof a===_.Cc}else a=!1;a?this.a=new GA:(this.f.warn("No WebCrypto APIs found. Will fallback to software AES"),this.a=new EA);this.b=this.c.getNetworkEngine();this.b.qd(this.h)};
_.r.release=function(){this.b&&this.b.$d(this.h);this.a&&(this.a.destroy(),this.a=null);this.b=null;this.g={}};_.r.id=function(){return"clpp.component.crypto"};_.r.Oi=function(a){var b=this,c,d;return _.z(function(e){if(1==e.a){c=a.request||null;if(!c||c.type!==_.Bn||!c.keyInfo||!a.data){e.a=2;return}b.f.debug("Decrypt data");d=a;return _.x(e,JA(b,a.data,c.keyInfo),4)}2!=e.a&&(d.data=e.b);return e["return"](a)})};_.B("clpp.crypto.CryptoComponent",HA);};f.call(g, window);