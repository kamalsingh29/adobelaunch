(function(){var g={}; var _ = _ || {};
var f=function(window){var Dq="clpp.persistent",Eq=function(a,b){for(var c=[],d=_.v(a),e=d.next();!e.done;e=d.next())c.push(b(e.value));return c},Fq=function(a){a=a.f.keys();a=Eq(a,function(b){return b.sessionId});return Array.from(a)},Hq=function(a,b,c,d,e,f){a.C=Gq;var g=new Map;g.set(b,{audioCapabilities:e,videoCapabilities:f,distinctiveIdentifier:_.cd,persistentState:_.rd,sessionTypes:[_.id],label:b,drmInfos:[{keySystem:b,licenseServerUri:c,distinctiveIdentifierRequired:!1,persistentStateRequired:!0,audioRobustness:"",
videoRobustness:"",serverCertificate:d,initData:null,keyIds:null}]});return _.Mi(a,g)},Iq=function(a,b){var c,d,e;return _.z(function(f){if(1==f.a)return _.x(f,_.Ti(a,b),2);c=f.b;if(!c)return a.b.debug("Ignoring attempt to remove missing session",b),f["return"]();d=[];(e=a.f.get(c))&&a.j&&(e.Ha=new _.Of,d.push(e.Ha));a.b.debug("Attempting to remove session",b);d.push(c.remove());return f["return"](Promise.all(d))})},Jq=function(a,b){var c=_.rh(a),d=b||_.Kg(),e=new _.Ci({Ab:new _.fg,onError:function(){},
Sd:function(){},onExpirationUpdated:function(){},onEvent:function(){},getConfiguration:function(){return d}});e.c=c;return e},Lq=function(){this.a=null;this.c=Kq;this.b=new _.E(Dq)},Nq=function(a,b){var c,d,e,f,g,h,l,m;return _.z(function(n){switch(n.a){case 1:if(0===b.length)return n["return"]();c=a.a.getDrmInfo();if(!c)return a.b.debug("No DRM info available for current stream"),n["return"]();d=Mq(a,c);e=null;return _.x(n,a.c.get(b),2);case 2:if(f=n.b)return a.b.debug("A persistent DRM session already exits for: ",
b),n["return"]();g=a.a.getConfiguration();h=g.drm;if(!h)return a.b.debug("No DRM configuration found for loaded source."),n["return"]();n.c=3;e=Jq(h,a.a.getConfiguration());var p=e;var q=[d];p.C=1;p.v=[];p.u=!0;p=_.Gi(p,q);return _.x(n,p,5);case 5:return _.x(n,e.setServerCertificate(),6);case 6:return _.x(n,_.Pi(e),7);case 7:return l=e.getDrmInfo(),f={sessionIds:Fq(e),keySystem:l.keySystem,licenseServerUri:l.licenseServerUri,serverCertificate:l.serverCertificate,audioCapabilities:[],videoCapabilities:[{contentType:_.pi(d.video.mimeType,
d.video.codecs),robustness:l.videoRobustness}],drmConfig:h},_.x(n,a.c.store(b,f),8);case 8:return _.x(n,e.destroy(),9);case 9:_.Be(n,0);break;case 3:m=_.Ce(n);a.b.error("Error while persisting DRM session");if(!e){n.a=10;break}return _.x(n,e.destroy(),10);case 10:throw new _.K(1,6,6200,null,m);}})},Mq=function(a,b){return{id:0,language:_.Od,primary:!1,audio:null,video:{id:0,originalId:null,createSegmentIndex:Promise.resolve.bind(Promise),findSegmentPosition:function(){return null},getSegmentReference:function(){return null},
adjustSegmentDurations:function(){},getDuration:function(){return a.a.getDuration()},initSegmentReference:null,presentationTimeOffset:0,mimeType:_.Zd,codecs:"avc1.42E01E",encrypted:!0,keyId:null,language:_.Od,label:null,type:_.Xd,primary:!1,frameRate:void 0,Gi:void 0,trickModeVideo:null,emsgSchemeIdUris:null,roles:[],channelsCount:null,Sf:null,closedCaptions:null},bandwidth:100,drmInfos:[b],allowedByApplication:!0,allowedByKeySystem:!0}},Oq=function(){},Pq=function(a){a=JSON.parse(a);var b=JSON.parse(a.sessionIds),
c=JSON.parse(a.audioCapabilities),d=JSON.parse(a.videoCapabilities),e=JSON.parse(a.serverCertificate),f=JSON.parse(a.drmConfig);return{sessionIds:b,keySystem:a.keySystem,licenseServerUri:decodeURIComponent(a.licenseServerUri),serverCertificate:new Uint8Array(e),audioCapabilities:c,videoCapabilities:d,drmConfig:f}},Gq=2;_.w(Lq,_.wl);_.r=Lq.prototype;_.r.ub=function(a){this.a=a};_.r.cb=function(){this.a=null};_.r.release=function(){};_.r.lc=function(){this.c=Kq};_.r.qe=function(){var a=this,b=this.a.getConfiguration().drm||null;b&&b.offlineId&&Nq(this,b.offlineId).then(function(){a.a.trigger(new _.I(_.tc,{offlineId:b.offlineId}))})["catch"](function(c){a.a.onError(c)})};_.r.id=function(){return _.cc};
_.r.Fh=function(a){var b=this,c;return _.z(function(d){if(1==d.a)return d.c=2,_.x(d,b.c.get(a),4);if(2!=d.a){if(c=d.b)return d["return"](c.sessionIds);b.b.debug("No offline session found for "+a);return d["return"]([])}_.Ce(d);b.b.warn("Error while loading session info from storage");return d["return"]([])})};_.B("clpp.persistent.PersistentLicenseComponent",Lq);_.r=Oq.prototype;
_.r.store=function(a,b){var c;return _.z(function(d){var e=JSON.stringify(b.sessionIds),f=Array.from(b.serverCertificate);f=JSON.stringify(f);var g=JSON.stringify(b.audioCapabilities),h=JSON.stringify(b.videoCapabilities);c=JSON.stringify({sessionIds:e,keySystem:b.keySystem,licenseServerUri:encodeURIComponent(b.licenseServerUri),serverCertificate:f,audioCapabilities:g,videoCapabilities:h,drmConfig:JSON.stringify(b.drmConfig)});window.localStorage.setItem(encodeURIComponent(a),btoa(c));_.y(d)})};
_.r.get=function(a){var b;return _.z(function(c){return(b=window.localStorage.getItem(encodeURIComponent(a)))?c["return"](Pq(atob(b))):c["return"](null)})};_.r["delete"]=function(a){return _.z(function(b){window.localStorage.removeItem(encodeURIComponent(a));_.y(b)})};_.r.clear=function(){return _.z(function(a){window.localStorage.clear();_.y(a)})};_.r.getName=function(){return"clpp.persistent.SimpleSessionStorage"};_.B("clpp.persistent.useStorage",function(a){var b=["store","get","delete","clear","getName"];var c=[];_.J.H(a)||(_.J.yb(a.store)||c.push("store"),_.J.yb(a.get)||c.push("get"),_.J.yb(a["delete"])||c.push("delete"),_.J.yb(a.clear)||c.push("clear"),_.J.yb(a.getName)||c.push("getName"),b=c);if(0<b.length)throw Qq.warn("Invalid session storage implementation"),new _.K(1,6,6202,{missingMethods:b});Kq=a});
_.B("clpp.persistent.removeLicense",function(a){var b,c,d,e,f;return _.z(function(g){switch(g.a){case 1:b=Kq;c=Qq;if(!_.J.X(a)||0===a.length)return c.warn("Invalid offlineId"),g["return"]();d=null;g.c=2;return _.x(g,b.get(a),4);case 4:e=g.b;if(!e)return c.debug("No persistent DRM session found"),g["return"]();e.drmConfig.delayLicenseRequestUntilPlayed=!0;d=Jq(e.drmConfig);return _.x(g,Hq(d,e.keySystem,e.licenseServerUri,e.serverCertificate,e.audioCapabilities,e.videoCapabilities),5);case 5:return _.x(g,
d.setServerCertificate(),6);case 6:return _.x(g,Promise.all(e.sessionIds.map(function(h){return _.z(function(l){if(1==l.a)return _.x(l,Iq(d,h),2);c.debug("sucessfully removed session with id",h);_.y(l)})})),7);case 7:return _.x(g,b["delete"](a),8);case 8:return _.x(g,d.destroy(),9);case 9:_.Be(g,0);break;case 2:f=_.Ce(g);c.error("Failed to remove session");if(!d){g.a=10;break}return _.x(g,d.destroy(),10);case 10:throw new _.K(1,6,6201,null,f);}})});var Kq=new Oq,Qq=new _.E(Dq);};
if(typeof(module)!="undefined"&&module.exports){var x=require("./cl.core.min.js");_ = x._;(f.call(g,this));module.exports=g;}
else if (typeof(define)!="undefined"&&define.amd) {define(["./cl.core.min"], function(c){x=c._;(f.call(g,this));return g;});}
else{_=this.clpp._;(f.call(g,this));}
})();
